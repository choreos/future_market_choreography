<process name="Carrefutur"
         targetNamespace="http://petals.ow2.org/bpel/Carrefutur/"          
         xmlns:tns="http://petals.ow2.org/bpel/Carrefutur/"
         xmlns:artifacts="http://petals.ow2.org/bpel/Carrefutur/Artifacts"
         xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable" xmlns:ns="http://services.choreos.eu/" xmlns:ns0="http://smregistry.choreos.eu">

    <!-- Import the client WSDL -->
    <bpel:import namespace="http://smregistry.choreos.eu" location="smregistry.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
    <bpel:import namespace="http://services.choreos.eu/" location="carrefuturWS.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
    <import location="CarrefuturDefinition.wsdl" 
			namespace="http://petals.ow2.org/bpel/Carrefutur/" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
	        
	<import location="CarrefuturArtifacts.wsdl"
			namespace="http://petals.ow2.org/bpel/Carrefutur/Artifacts"
			importType="http://schemas.xmlsoap.org/wsdl/" />
	                
    <!-- ================================================================= -->         
    <!-- PARTNERLINKS                                                      -->
    <!-- List of services participating in this BPEL process               -->
    <!-- ================================================================= -->         
    <partnerLinks>
        <!-- The 'client' role represents the requester of this service. -->
        <partnerLink name="orchestrator"
                     partnerLinkType="artifacts:CarrefuturPLT"
                     myRole="CarrefuturRole" />
        <bpel:partnerLink name="CarrefuturWSPartner" partnerLinkType="artifacts:CarrefuturPT" myRole="carrefuturRole" partnerRole="carrefuturRole"></bpel:partnerLink>
        <bpel:partnerLink name="SMRegistryPartner" partnerLinkType="artifacts:SMRegistryPT" myRole="SMRegistryRole" partnerRole="SMRegistryRole"></bpel:partnerLink>
    </partnerLinks>
  
    <!-- ================================================================= -->         
    <!-- VARIABLES                                                         -->
    <!-- List of messages and XML documents used within this BPEL process  -->
    <!-- ================================================================= -->         
    <variables>
    	
        
        
        <bpel:variable name="registerSupermarketRequest" element="tns:registerSupermarket"></bpel:variable>
        <bpel:variable name="CarrefuturWSPartnerResponse" messageType="ns:calculatePriceOfResponse"></bpel:variable>
        <bpel:variable name="CarrefuturWSPartnerRequest" messageType="ns:calculatePriceOf"></bpel:variable>
        
        
        <bpel:variable name="SMRegistryPartnerResponse" messageType="ns0:addSupermarketResponse"></bpel:variable>
        <bpel:variable name="SMRegistryPartnerRequest" messageType="ns0:addSupermarket"></bpel:variable>
        
        <bpel:variable name="registerSupermarketResponse" element="tns:registerSupermarketResponse"></bpel:variable>
        <bpel:variable name="searchForProductRequest" messageType="tns:CarrefuturRequestMessage"></bpel:variable>
        <bpel:variable name="searchForProductResponse" messageType="tns:CarrefuturResponseMessage"></bpel:variable>
    </variables>

    <!-- ================================================================= -->         
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->         
    <sequence name="MainSequence">
    	
        <bpel:pick name="Pick">
            <bpel:onMessage partnerLink="orchestrator" operation="searchForProduct" portType="tns:CarrefuturPortType" variable="searchForProductRequest">
                <bpel:sequence name="Sequence">
                    <bpel:assign validate="no" name="Assign">
                        
                        
                        
                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal xml:space="preserve"><tns:calculatePriceOf xmlns:tns="http://services.choreos.eu/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
</tns:calculatePriceOf>
</bpel:literal>
                            </bpel:from>
                            <bpel:to variable="CarrefuturWSPartnerRequest" part="parameters"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="payload" variable="searchForProductRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:name]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="CarrefuturWSPartnerRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[arg0]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:invoke name="Invoke" partnerLink="CarrefuturWSPartner" operation="calculatePriceOf" portType="ns:CarrefuturWS" inputVariable="CarrefuturWSPartnerRequest" outputVariable="CarrefuturWSPartnerResponse"></bpel:invoke>
                    <bpel:assign validate="no" name="Assign1">
                        
                        
                        
                        
                        
                        
                        
                        
                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal xml:space="preserve"><tns:searchForProductResponse xmlns:tns="http://petals.ow2.org/bpel/Carrefutur/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:return>
    <tns:name></tns:name>
    <tns:price></tns:price>
  </tns:return>
</tns:searchForProductResponse>
</bpel:literal>
                            </bpel:from>
                            <bpel:to variable="searchForProductResponse" part="payload"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="CarrefuturWSPartnerResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[return]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="payload" variable="searchForProductResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:return/tns:price]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="CarrefuturWSPartnerRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[arg0]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="payload" variable="searchForProductResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:return/tns:name]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:reply name="Reply" partnerLink="orchestrator" operation="searchForProduct" portType="tns:CarrefuturPortType" variable="searchForProductResponse"></bpel:reply>
                </bpel:sequence>
            </bpel:onMessage>
            <bpel:onMessage partnerLink="orchestrator" operation="registerSupermarket" portType="tns:CarrefuturPortType" variable="registerSupermarketRequest">
                <bpel:sequence name="Sequence1">
                    <bpel:assign validate="no" name="Assign2">
                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal xml:space="preserve"><tns:addSupermarket xmlns:tns="http://smregistry.choreos.eu" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
</tns:addSupermarket>
</bpel:literal>
                            </bpel:from>
                            <bpel:to variable="SMRegistryPartnerRequest" part="parameters"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from variable="registerSupermarketRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:in]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="SMRegistryPartnerRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[arg0]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:invoke name="Invoke1" partnerLink="SMRegistryPartner" operation="addSupermarket" portType="ns0:SMRegistryWS" inputVariable="SMRegistryPartnerRequest" outputVariable="SMRegistryPartnerResponse"></bpel:invoke>
                    <bpel:assign validate="no" name="Assign3">
                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal xml:space="preserve"><tns:registerSupermarketResponse xmlns:tns="http://petals.ow2.org/bpel/Carrefutur/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:out></tns:out>
</tns:registerSupermarketResponse>
</bpel:literal>
                            </bpel:from>
                            <bpel:to variable="registerSupermarketResponse"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="SMRegistryPartnerResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[return]]></bpel:query>
                            </bpel:from>
                            <bpel:to variable="registerSupermarketResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:out]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:reply name="Reply1" partnerLink="orchestrator" operation="registerSupermarket" portType="tns:CarrefuturPortType" variable="registerSupermarketResponse"></bpel:reply>
                </bpel:sequence>
            </bpel:onMessage>
        </bpel:pick>
    </sequence>
</process>
