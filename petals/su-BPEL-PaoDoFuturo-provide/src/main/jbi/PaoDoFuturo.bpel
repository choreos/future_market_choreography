<process name="PaoDoFuturo"
         targetNamespace="http://petals.ow2.org/bpel/PaoDoFuturo/"          
         xmlns:tns="http://petals.ow2.org/bpel/PaoDoFuturo/"
         xmlns:artifacts="http://petals.ow2.org/bpel/PaoDoFuturo/Artifacts"
         xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable" xmlns:ns="http://services.choreos.eu/" xmlns:ns0="http://smregistry.choreos.eu">

    <!-- Import the client WSDL -->
    <bpel:import namespace="http://smregistry.choreos.eu" location="smregistry.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
    <bpel:import namespace="http://services.choreos.eu/" location="paoDoFuturoWS.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
    <import location="PaoDoFuturoDefinition.wsdl" 
			namespace="http://petals.ow2.org/bpel/PaoDoFuturo/" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
	        
	<import location="PaoDoFuturoArtifacts.wsdl"
			namespace="http://petals.ow2.org/bpel/PaoDoFuturo/Artifacts"
			importType="http://schemas.xmlsoap.org/wsdl/" />
	                
    <!-- ================================================================= -->         
    <!-- PARTNERLINKS                                                      -->
    <!-- List of services participating in this BPEL process               -->
    <!-- ================================================================= -->         
    <partnerLinks>
        <!-- The 'client' role represents the requester of this service. -->
        <partnerLink name="orchestrator"
                     partnerLinkType="artifacts:PaoDoFuturoPLT"
                     myRole="PaoDoFuturoRole" />
        <bpel:partnerLink name="paoDoFuturoWS" partnerLinkType="artifacts:PaoDoFuturoPT" myRole="PaoDoFuturoRole" partnerRole="PaoDoFuturoRole"></bpel:partnerLink>
        <bpel:partnerLink name="SMRegistry" partnerLinkType="artifacts:smRegistryPT" myRole="smRegistryRole" partnerRole="smRegistryRole"></bpel:partnerLink>
    </partnerLinks>
  
    <!-- ================================================================= -->         
    <!-- VARIABLES                                                         -->
    <!-- List of messages and XML documents used within this BPEL process  -->
    <!-- ================================================================= -->         
    <variables>
    	<bpel:variable 	name="searchForProductRequest" 
    					messageType="tns:PaoDoFuturoRequestMessage" />
        <bpel:variable name="paoDoFuturoWSResponse" messageType="ns:getProductPriceByNameResponse"></bpel:variable>
        <bpel:variable name="paoDoFuturoWSRequest" messageType="ns:getProductPriceByName"></bpel:variable>
        <bpel:variable name="searchForProductResponse" messageType="tns:PaoDoFuturoResponseMessage"></bpel:variable>
        <bpel:variable name="registerSupermarketRequest" messageType="tns:registerSupermarketRequest"></bpel:variable>
        <bpel:variable name="SMRegistryResponse" messageType="ns0:addSupermarketResponse"></bpel:variable>
        <bpel:variable name="SMRegistryRequest" messageType="ns0:addSupermarket"></bpel:variable>
        <bpel:variable name="registerSupermarketResponse" messageType="tns:registerSupermarketResponse"></bpel:variable>
    </variables>

    <!-- ================================================================= -->         
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->         
    <sequence name="MainSequence">
    	
        <bpel:pick name="Pick">
            <bpel:onMessage partnerLink="orchestrator" operation="searchForProduct" portType="tns:PaoDoFuturoPortType" variable="searchForProductRequest">
                <bpel:sequence name="Sequence">
                    <bpel:assign validate="no" name="Assign">
                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal xml:space="preserve"><tns:getProductPriceByName xmlns:tns="http://services.choreos.eu/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
</tns:getProductPriceByName>
</bpel:literal>
                            </bpel:from>
                            <bpel:to variable="paoDoFuturoWSRequest" part="parameters"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="payload" variable="searchForProductRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:name]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="paoDoFuturoWSRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[arg0]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:invoke name="Invoke" partnerLink="paoDoFuturoWS" operation="getProductPriceByName" portType="ns:PaoDoFuturoWS" inputVariable="paoDoFuturoWSRequest" outputVariable="paoDoFuturoWSResponse"></bpel:invoke>
                    <bpel:assign validate="no" name="Assign1">
                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal xml:space="preserve"><tns:searchForProductResponse xmlns:tns="http://petals.ow2.org/bpel/PaoDoFuturo/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:return>
    <tns:name></tns:name>
    <tns:price></tns:price>
  </tns:return>
</tns:searchForProductResponse>
</bpel:literal>
                            </bpel:from>
                            <bpel:to variable="searchForProductResponse" part="payload"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="paoDoFuturoWSResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[return]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="payload" variable="searchForProductResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:return/tns:price]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="paoDoFuturoWSRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[arg0]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="payload" variable="searchForProductResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:return/tns:name]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:reply name="Reply" partnerLink="orchestrator" operation="searchForProduct" portType="tns:PaoDoFuturoPortType" variable="searchForProductResponse"></bpel:reply>
                </bpel:sequence>
            </bpel:onMessage>
            <bpel:onMessage partnerLink="orchestrator" operation="registerSupermarket" portType="tns:PaoDoFuturoPortType" variable="registerSupermarketRequest">
                <bpel:sequence name="Sequence1">
                    <bpel:assign validate="no" name="Assign2">
                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal xml:space="preserve"><tns:addSupermarket xmlns:tns="http://smregistry.choreos.eu" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
</tns:addSupermarket>
</bpel:literal>
                            </bpel:from>
                            <bpel:to variable="SMRegistryRequest" part="parameters"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="registerSupermarketRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:in]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="SMRegistryRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[arg0]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:invoke name="Invoke1" partnerLink="SMRegistry" operation="addSupermarket" portType="ns0:SMRegistryWS" inputVariable="SMRegistryRequest" outputVariable="SMRegistryResponse"></bpel:invoke>
                    <bpel:assign validate="no" name="Assign3">
                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal xml:space="preserve"><tns:registerSupermarketResponse xmlns:tns="http://petals.ow2.org/bpel/PaoDoFuturo/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:out></tns:out>
</tns:registerSupermarketResponse>
</bpel:literal>
                            </bpel:from>
                            <bpel:to variable="registerSupermarketResponse" part="parameters"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="SMRegistryResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[return]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="registerSupermarketResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:out]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:reply name="Reply1" partnerLink="orchestrator" operation="registerSupermarket" portType="tns:PaoDoFuturoPortType" variable="registerSupermarketResponse"></bpel:reply>
                </bpel:sequence>
            </bpel:onMessage>
        </bpel:pick>
    </sequence>
</process>
