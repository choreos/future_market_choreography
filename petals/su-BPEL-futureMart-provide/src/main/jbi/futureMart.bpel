<process name="futureMart"
         targetNamespace="http://petals.ow2.org/bpel/futureMart/"          
         xmlns:tns="http://petals.ow2.org/bpel/futureMart/"
         xmlns:artifacts="http://petals.ow2.org/bpel/futureMart/Artifacts"
         xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable" xmlns:ns="http://services.choreos.eu/" xmlns:ns0="http://smregistry.choreos.eu">

    <!-- Import the client WSDL -->
    <bpel:import namespace="http://smregistry.choreos.eu" location="smregistry.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
    <bpel:import namespace="http://services.choreos.eu/" location="futureMartWS.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
    <import location="futureMartDefinition.wsdl" 
			namespace="http://petals.ow2.org/bpel/futureMart/" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
	        
	<import location="futureMartArtifacts.wsdl"
			namespace="http://petals.ow2.org/bpel/futureMart/Artifacts"
			importType="http://schemas.xmlsoap.org/wsdl/" />
	                
    <!-- ================================================================= -->         
    <!-- PARTNERLINKS                                                      -->
    <!-- List of services participating in this BPEL process               -->
    <!-- ================================================================= -->         
    <partnerLinks>
        <!-- The 'client' role represents the requester of this service. -->
        
        <bpel:partnerLink name="futureMarWSPartner" partnerLinkType="artifacts:futureMartPT" myRole="futureMartWSRole" partnerRole="futureMartWSRole"></bpel:partnerLink>
        <bpel:partnerLink name="orchestrator" partnerLinkType="artifacts:orchestratorPT" partnerRole="orchestratorRole" myRole="orchestratorRole"></bpel:partnerLink>
        <bpel:partnerLink name="smRegistryWSPartner" partnerLinkType="artifacts:smRegistryPT" myRole="smRegistryRole" partnerRole="smRegistryRole"></bpel:partnerLink>
    </partnerLinks>
  
    <!-- ================================================================= -->         
    <!-- VARIABLES                                                         -->
    <!-- List of messages and XML documents used within this BPEL process  -->
    <!-- ================================================================= -->         
    <variables>
    	<bpel:variable 	name="futureMartPartnerRequest" 
    					messageType="tns:futureMartRequestMessage" />
        <bpel:variable name="futureMarWSPartnerResponse" messageType="ns:getPriceResponse"></bpel:variable>
        <bpel:variable name="futureMarWSPartnerRequest" messageType="ns:getPrice"></bpel:variable>
        
        <bpel:variable name="orchestratorResponse" messageType="tns:futureMartResponseMessage"></bpel:variable>
        <bpel:variable name="orchestratorRequest" messageType="tns:registerSupermarketRequest"></bpel:variable>
        <bpel:variable name="smRegistryWSPartnerResponse" messageType="ns0:addSupermarketResponse"></bpel:variable>
        <bpel:variable name="smRegistryWSPartnerRequest" messageType="ns0:addSupermarket"></bpel:variable>
        <bpel:variable name="orchestratorResponse1" messageType="tns:registerSupermarketResponse"></bpel:variable>
    </variables>

    <!-- ================================================================= -->         
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->         
    <sequence name="MainSequence">
    	
        
        
        
        
        <bpel:pick name="Pick">
            <bpel:onMessage partnerLink="orchestrator" operation="searchForProduct" portType="tns:futureMartPortType" variable="futureMartPartnerRequest">
                <bpel:sequence>
                    <bpel:assign validate="no" name="Assign">
            
            
    
    
    
                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal xml:space="preserve"><tns:getPrice xmlns:tns="http://services.choreos.eu/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
</tns:getPrice>
</bpel:literal>
                            </bpel:from>
                            <bpel:to variable="futureMarWSPartnerRequest" part="parameters"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="payload" variable="futureMartPartnerRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:input]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="futureMarWSPartnerRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[arg0]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:invoke name="Invoke" partnerLink="futureMarWSPartner" operation="getPrice" portType="ns:FutureMartWS" inputVariable="futureMarWSPartnerRequest" outputVariable="futureMarWSPartnerResponse"></bpel:invoke>
                    <bpel:assign validate="no" name="Assign1">
            
            
    
    
    
    
    

                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal xml:space="preserve"><tns:searchForProductResponse xmlns:tns="http://petals.ow2.org/bpel/futureMart/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:return>
    <tns:name></tns:name>
    <tns:price></tns:price>
  </tns:return>
</tns:searchForProductResponse>
</bpel:literal>
                            </bpel:from>
                            <bpel:to variable="orchestratorResponse" part="payload"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="futureMarWSPartnerResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[return]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="payload" variable="orchestratorResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:return/tns:price]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="futureMarWSPartnerRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[arg0]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="payload" variable="orchestratorResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:return/tns:name]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:reply name="Reply" partnerLink="orchestrator" operation="searchForProduct" portType="tns:futureMartPortType" variable="orchestratorResponse"></bpel:reply>
                </bpel:sequence>
            </bpel:onMessage>
            <bpel:onMessage partnerLink="orchestrator" operation="registerSupermarket" portType="tns:futureMartPortType" variable="orchestratorRequest">
                <bpel:sequence name="Sequence">
                    <bpel:assign validate="no" name="Assign2">
                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal xml:space="preserve"><tns:addSupermarket xmlns:tns="http://smregistry.choreos.eu" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
</tns:addSupermarket>
</bpel:literal>
                            </bpel:from>
                            <bpel:to variable="smRegistryWSPartnerRequest" part="parameters"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="orchestratorRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:input]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="smRegistryWSPartnerRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[arg0]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:invoke name="Invoke1" partnerLink="smRegistryWSPartner" operation="addSupermarket" portType="ns0:SMRegistryWS" inputVariable="smRegistryWSPartnerRequest" outputVariable="smRegistryWSPartnerResponse"></bpel:invoke>
                    <bpel:assign validate="no" name="Assign3">
                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal xml:space="preserve"><tns:registerSupermarketResponse xmlns:tns="http://petals.ow2.org/bpel/futureMart/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:return></tns:return>
</tns:registerSupermarketResponse>
</bpel:literal>
                            </bpel:from>
                            <bpel:to variable="orchestratorResponse1" part="parameters"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="smRegistryWSPartnerResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[return]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="orchestratorResponse1">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:return]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:reply name="Reply1" partnerLink="orchestrator" operation="registerSupermarket" portType="tns:futureMartPortType" variable="orchestratorResponse1"></bpel:reply>
                </bpel:sequence>
            </bpel:onMessage>
        </bpel:pick>
        
        
        
        
        
    </sequence>
</process>
