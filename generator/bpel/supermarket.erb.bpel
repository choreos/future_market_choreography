<process name="supermarket"
         targetNamespace="http://petals.ow2.org/bpel/supermarket/"          
         xmlns:tns="http://petals.ow2.org/bpel/supermarket/"
         xmlns:artifacts="http://petals.ow2.org/bpel/supermarket/Artifacts"
         xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable" xmlns:ns="http://services.choreos.eu/" xmlns:ns0="http://smregistry.choreos.eu" xmlns:ns1="http://petals.ow2.org/bpel/Shipper1/">

    <!-- Import the client WSDL -->
    <bpel:import namespace="http://petals.ow2.org/bpel/Shipper1/" location="Shipper1Definition.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
    <bpel:import namespace="http://smregistry.choreos.eu" location="smregistry.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
    <bpel:import namespace="http://services.choreos.eu/" location="SM<%=@id%>.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
    <import location="supermarketDefinition.wsdl" 
			namespace="http://petals.ow2.org/bpel/supermarket/" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
	        
	<import location="supermarketArtifacts.wsdl"
			namespace="http://petals.ow2.org/bpel/supermarket/Artifacts"
			importType="http://schemas.xmlsoap.org/wsdl/" />
	                
    <!-- ================================================================= -->         
    <!-- PARTNERLINKS                                                      -->
    <!-- List of services participating in this BPEL process               -->
    <!-- ================================================================= -->         
    <partnerLinks>
        <!-- The 'client' role represents the requester of this service. -->
        <partnerLink name="orchestratorPartner"
                     partnerLinkType="artifacts:supermarketPLT"
                     myRole="supermarketRole" partnerRole="supermarketRole"/>
        <bpel:partnerLink name="supermarketWSPartner" partnerLinkType="artifacts:supermarketPLT" myRole="supermarketRole" partnerRole="supermarketRole"></bpel:partnerLink>
        <bpel:partnerLink name="registryWS" partnerLinkType="artifacts:SMRegistryPT" myRole="SMRegistryRole" partnerRole="SMRegistryRole"></bpel:partnerLink>
        <bpel:partnerLink name="shipper" partnerLinkType="artifacts:shipperPT" myRole="shipperRole" partnerRole="shipperRole"></bpel:partnerLink>
    </partnerLinks>
  
    <!-- ================================================================= -->         
    <!-- VARIABLES                                                         -->
    <!-- List of messages and XML documents used within this BPEL process  -->
    <!-- ================================================================= -->         
    <variables>
    	<bpel:variable 	name="searchForProductRequest" 
    					messageType="tns:supermarketRequestMessage" />
        <bpel:variable name="supermarketWSPartnerResponse" messageType="ns:getPriceResponse"></bpel:variable>
        <bpel:variable name="supermarketWSPartnerRequest" messageType="ns:getPrice"></bpel:variable>
        <bpel:variable name="searchForProductResponse" messageType="tns:supermarketResponseMessage"></bpel:variable>
        <bpel:variable name="registerSupermarketRequest" messageType="tns:registerSupermarketRequest"></bpel:variable>
        <bpel:variable name="registryWSResponse" messageType="ns0:addSupermarketResponse"></bpel:variable>
        <bpel:variable name="registryWSRequest" messageType="ns0:addSupermarket"></bpel:variable>
        <bpel:variable name="registerSupermarketResponse" messageType="tns:registerSupermarketResponse"></bpel:variable>
        <bpel:variable name="purchaseRequest" messageType="tns:purchaseRequest"></bpel:variable>
        <bpel:variable name="shipperResponse" messageType="ns1:setDeliveryDataResponse"></bpel:variable>
        <bpel:variable name="shipperRequest" messageType="ns1:setDeliveryDataRequest"></bpel:variable>
        <bpel:variable name="purchaseResponse" messageType="tns:purchaseResponse"></bpel:variable>
    </variables>

    <!-- ================================================================= -->         
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->         
    <sequence name="MainSequence">
    	
        <bpel:pick name="Pick">
            <bpel:onMessage partnerLink="orchestratorPartner" operation="searchForProduct" portType="tns:supermarket<%=@id%>PortType" variable="searchForProductRequest">
                <bpel:sequence>
                    <bpel:assign validate="no" name="Assign">
                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal xml:space="preserve"><tns:getPrice xmlns:tns="http://services.choreos.eu/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
</tns:getPrice>
</bpel:literal>
                            </bpel:from>
                            <bpel:to variable="supermarketWSPartnerRequest" part="parameters"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="payload" variable="searchForProductRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:name]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="supermarketWSPartnerRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[arg0]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:invoke name="Invoke" partnerLink="supermarketWSPartner" operation="getPrice" portType="ns:SM<%=@id%>PortType" inputVariable="supermarketWSPartnerRequest" outputVariable="supermarketWSPartnerResponse"></bpel:invoke>
                    <bpel:assign validate="no" name="Assign1">
                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal xml:space="preserve"><tns:searchForProductResponse xmlns:tns="http://petals.ow2.org/bpel/supermarket/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:return>
    <tns:name></tns:name>
    <tns:price></tns:price>
  </tns:return>
</tns:searchForProductResponse>
</bpel:literal>
                            </bpel:from>
                            <bpel:to variable="searchForProductResponse" part="payload"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="supermarketWSPartnerResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[return]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="payload" variable="searchForProductResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:return/tns:price]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="supermarketWSPartnerRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[arg0]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="payload" variable="searchForProductResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:return/tns:name]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:reply name="Reply" partnerLink="orchestratorPartner" operation="searchForProduct" portType="tns:supermarket<%=@id%>PortType" variable="searchForProductResponse"></bpel:reply>
                </bpel:sequence>
            </bpel:onMessage>
            <bpel:onMessage partnerLink="orchestratorPartner" operation="registerSupermarket" portType="tns:supermarket<%=@id%>PortType" variable="registerSupermarketRequest">
                <bpel:sequence>
                    <bpel:assign validate="no" name="Assign2">
                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal xml:space="preserve"><tns:addSupermarket xmlns:tns="http://smregistry.choreos.eu" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
</tns:addSupermarket>
</bpel:literal>
                            </bpel:from>
                            <bpel:to variable="registryWSRequest" part="parameters"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="registerSupermarketRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:in]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="registryWSRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[arg0]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:invoke name="Invoke1" partnerLink="registryWS" operation="addSupermarket" portType="ns0:SMRegistryWS" inputVariable="registryWSRequest" outputVariable="registryWSResponse"></bpel:invoke>
                    <bpel:assign validate="no" name="Assign3">
                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal xml:space="preserve"><tns:registerSupermarketResponse xmlns:tns="http://petals.ow2.org/bpel/supermarket/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:out></tns:out>
</tns:registerSupermarketResponse>
</bpel:literal>
                            </bpel:from>
                            <bpel:to variable="registerSupermarketResponse" part="parameters"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="registryWSResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[return]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="registerSupermarketResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:out]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:reply name="Reply1" partnerLink="orchestratorPartner" operation="registerSupermarket" portType="tns:supermarket<%=@id%>PortType" variable="registerSupermarketResponse"></bpel:reply>
                </bpel:sequence>
            </bpel:onMessage>
            <bpel:onMessage partnerLink="supermarketWSPartner" operation="purchase" portType="tns:supermarket<%=@id%>PortType" variable="purchaseRequest">
                <bpel:sequence name="Sequence">
                    <bpel:assign validate="no" name="Assign4">
                        
                        
                        
                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal xml:space="preserve"><tns:setDeliveryData xmlns:tns="http://petals.ow2.org/bpel/Shipper1/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:id></tns:id>
  <tns:personalData>
    <tns:name></tns:name>
    <tns:address></tns:address>
    <tns:zipcode></tns:zipcode>
  </tns:personalData>
</tns:setDeliveryData>
</bpel:literal>
                            </bpel:from>
                            <bpel:to variable="shipperRequest" part="parameters"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="purchaseRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:id]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="shipperRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns1:id]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="purchaseRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[tns:data/tns:name]]>
                                </bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="shipperRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[ns1:personalData/ns1:name]]>
                                </bpel:query>
                            </bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="purchaseRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:data/tns:address]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="shipperRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns1:personalData/ns1:address]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="purchaseRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:data/tns:zipcode]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="shipperRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns1:personalData/ns1:zipcode]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    
                    <bpel:invoke name="Invoke2" partnerLink="shipper" operation="setDeliveryData" portType="ns1:Shipper1PortType" inputVariable="shipperRequest" outputVariable="shipperResponse"></bpel:invoke>
                    <bpel:assign validate="no" name="Assign5">
                        
                        
                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal xml:space="preserve">Shipper1</bpel:literal>
                            </bpel:from>
                            <bpel:to part="parameters" variable="purchaseResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:confirmation]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:reply name="Reply2" partnerLink="supermarketWSPartner" operation="purchase" portType="tns:supermarket<%=@id%>PortType" variable="purchaseResponse"></bpel:reply>
                </bpel:sequence>
            </bpel:onMessage>
        </bpel:pick>
    </sequence>
</process>


